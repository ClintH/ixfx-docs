<!DOCTYPE html>
<html dir="ltr" lang="en-us" class="initial astro-VOYEGVQR">
	<head>
		<!-- Global Metadata --><meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<link rel="icon" type="image/svg+xml" href="/favicon.svg">
<link rel="alternate icon" type="image/x-icon" href="/favicon.ico">

<link rel="sitemap" href="/sitemap.xml">

<!-- Preload Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital@0;1&display=swap" rel="stylesheet">

<!-- Scrollable a11y code helper -->
<script type="module" src="/make-scrollable-code-focusable.js"></script>

<!-- This is intentionally inlined to avoid FOUC -->
<script>
	const root = document.documentElement;
	const theme = localStorage.getItem('theme');
	if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
		root.classList.add('theme-dark');
	} else {
		root.classList.remove('theme-dark');
	}
</script>

		<!-- Page Metadata --><link rel="canonical" href="https://clinth.github.io/ixfx-docs/flow/stateMachine/">

<!-- OpenGraph Tags -->
<meta property="og:title" content="State Machine - ixfx docs">
<meta property="og:type" content="article">
<meta property="og:url" content="https://clinth.github.io/ixfx-docs/flow/stateMachine/">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/clinth/ixfx/blob/main/assets/social/banner.jpg?raw=true">
<meta property="og:image:alt" content="ixfx">
<meta name="description" property="og:description" content="ixfx documentation">
<meta property="og:site_name" content="ixfx docs">

<!-- Twitter Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site">
<meta name="twitter:title" content="State Machine - ixfx docs">
<meta name="twitter:description" content="ixfx documentation">
<meta name="twitter:image" content="https://github.com/clinth/ixfx/blob/main/assets/social/banner.jpg?raw=true">
<meta name="twitter:image:alt" content="ixfx">

<!--
  TODO: Add json+ld data, maybe https://schema.org/APIReference makes sense?
  Docs: https://developers.google.com/search/docs/advanced/structured-data/intro-structured-data
  https://www.npmjs.com/package/schema-dts seems like a great resource for implementing this.
  Even better, there's a React component that integrates with `schema-dts`: https://github.com/google/react-schemaorg
-->

		<title>State Machine - ixfx docs</title>
		
	<link rel="stylesheet" href="/ixfx-docs/assets/StateMachinePlay.d2380cf2.css"></link>
<link rel="stylesheet" href="/ixfx-docs/assets/MainLayout.46c7210e.css"></link><style astro-style="true">astro-root, astro-fragment { display: contents; }</style><script type="module" src="/ixfx-docs/hoisted.9da302a7.js" astro-script="/flow/stateMachine/script-0"></script>
<script type="module" hoist="true" astro-script="/flow/stateMachine/script-1">import '/src/components/ReplPad';</script>
<script type="module" astro-script="/flow/stateMachine/script-2">import "../../client-shim.8cb18301.js";</script>
<script type="module" data-astro-component-hydration astro-script="/flow/stateMachine/script-3">import setup from '../../idle.cf066c8c.js';
setup("Z12Vj7s", {name:"SidebarToggle",value: true}, async () => {
  const [{ default: Component }, { default: hydrate }] = await Promise.all([import("../../SidebarToggle.d7ee5070.js"), import("../../client.c8b3fae7.js")]);
  return (el, children) => hydrate(el)(Component, {"class":"astro-MOSAUK67"}, children);

});
</script>
<script type="module" data-astro-component-hydration astro-script="/flow/stateMachine/script-4">import setup from '../../media.4019acd1.js';
setup("ZOVQf3", {name:"TableOfContents",value: "(min-width: 50em)"}, async () => {
  const [{ default: Component }, { default: hydrate }] = await Promise.all([import("../../TableOfContents.8febe64b.js"), import("../../client.c8b3fae7.js")]);
  return (el, children) => hydrate(el)(Component, {"headers":[{"depth":2,"slug":"machine-definition","text":"Machine definition"},{"depth":2,"slug":"why","text":"Why?"},{"depth":2,"slug":"playground","text":"Playground"},{"depth":2,"slug":"simple-usage","text":"Simple usage"},{"depth":2,"slug":"class-based-usage","text":"Class-based usage"},{"depth":2,"slug":"simple-machines","text":"Simple machines"},{"depth":2,"slug":"driver","text":"Driver"},{"depth":3,"slug":"demo","text":"Demo"}],"class":"astro-XPZS3NBI"}, children);

});
</script>
<script type="module" data-astro-component-hydration astro-script="/flow/stateMachine/script-5">import setup from '../../visible.6e568c09.js';
setup("1Gmxo9", {name:"ThemeToggleButton",value: true}, async () => {
  const [{ default: Component }, { default: hydrate }] = await Promise.all([import("../../ThemeToggleButton.da026e82.js"), import("../../client.c8b3fae7.js")]);
  return (el, children) => hydrate(el)(Component, {"class":"astro-WOEIVG5E"}, children);

});
</script>
<script type="module" data-astro-component-hydration astro-script="/flow/stateMachine/script-6">import setup from '../../media.4019acd1.js';
setup("ZOVQf3", {name:"TableOfContents",value: "(max-width: 50em)"}, async () => {
  const [{ default: Component }, { default: hydrate }] = await Promise.all([import("../../TableOfContents.8febe64b.js"), import("../../client.c8b3fae7.js")]);
  return (el, children) => hydrate(el)(Component, {"headers":[{"depth":2,"slug":"machine-definition","text":"Machine definition"},{"depth":2,"slug":"why","text":"Why?"},{"depth":2,"slug":"playground","text":"Playground"},{"depth":2,"slug":"simple-usage","text":"Simple usage"},{"depth":2,"slug":"class-based-usage","text":"Class-based usage"},{"depth":2,"slug":"simple-machines","text":"Simple machines"},{"depth":2,"slug":"driver","text":"Driver"},{"depth":3,"slug":"demo","text":"Demo"}],"class":"astro-AMOJLK4X"}, children);

});
</script>
</head>

	<body>
		<header class="astro-MOSAUK67">
	<a href="#article" class="sr-only skiplink astro-RC6GWYXJ"><span class="astro-RC6GWYXJ">Skip to Content</span></a>



	<nav class="nav-wrapper astro-MOSAUK67" title="Top Navigation">
		<div class="menu-toggle astro-MOSAUK67">
			<astro-root uid="Z12Vj7s"><button type="button" aria-pressed="false" id="menu-toggle"><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg><span class="sr-only">Toggle sidebar</span></button></astro-root>
		</div>
		<div class="logo flex astro-MOSAUK67">
			<!-- <AstroLogo size={40} /> -->
			<a href="/ixfx-docs/" class="astro-MOSAUK67">
				<h1 class="astro-MOSAUK67">ixfx docs</h1>
			</a>
		</div>
		<div style="flex-grow: 1;" class="astro-MOSAUK67"></div>
		<!-- {KNOWN_LANGUAGE_CODES.length > 1 && <LanguageSelect lang={lang} client:idle />} -->
		<!-- {CONFIG.ALGOLIA && (
			<div class="search-item">
				<Search client:idle />
			</div>
		)} -->
	</nav>
</header>



		<main class="layout astro-VOYEGVQR">
			<aside id="grid-left" class="grid-sidebar astro-VOYEGVQR" title="Site Navigation">
				<nav aria-labelledby="grid-left" class="astro-TIHETVVV">
	<ul class="nav-groups astro-TIHETVVV">
		<li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV"></h2>
					<ul class="astro-TIHETVVV">
						
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">Getting Started</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/./" aria-current="false" class="astro-TIHETVVV">
									Introduction
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/./importing/" aria-current="false" class="astro-TIHETVVV">
									Importing
								</a>
							</li>
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">Flow and Logic</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/flow/stateMachine/" aria-current="false" class="astro-TIHETVVV">
									State Machine
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/flow/loops/" aria-current="false" class="astro-TIHETVVV">
									Loops and Intervals
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/flow/delay/" aria-current="false" class="astro-TIHETVVV">
									Delay
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/flow/retrying/" aria-current="false" class="astro-TIHETVVV">
									Retrying
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/flow/flow/" aria-current="false" class="astro-TIHETVVV">
									Flow
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/flow/monitoring/" aria-current="false" class="astro-TIHETVVV">
									Monitoring
								</a>
							</li>
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">Modulation</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/easing/" aria-current="false" class="astro-TIHETVVV">
									Easing
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/envelope/" aria-current="false" class="astro-TIHETVVV">
									Envelope
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/forces/" aria-current="false" class="astro-TIHETVVV">
									Forces
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/jitter/" aria-current="false" class="astro-TIHETVVV">
									Jitter
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/interpolate/" aria-current="false" class="astro-TIHETVVV">
									Interpolate
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/oscillator/" aria-current="false" class="astro-TIHETVVV">
									Oscillator
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/modulation/spring/" aria-current="false" class="astro-TIHETVVV">
									Spring
								</a>
							</li>
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">Generation</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/gen/random/" aria-current="false" class="astro-TIHETVVV">
									Random
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/gen/generator/" aria-current="false" class="astro-TIHETVVV">
									Generators
								</a>
							</li>
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">Data</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/cleanup/" aria-current="false" class="astro-TIHETVVV">
									Clean up
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/normalising/" aria-current="false" class="astro-TIHETVVV">
									Normalising
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/arrays/" aria-current="false" class="astro-TIHETVVV">
									Arrays
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/collections/" aria-current="false" class="astro-TIHETVVV">
									Collections
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/averaging/" aria-current="false" class="astro-TIHETVVV">
									Averaging
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/frequency/" aria-current="false" class="astro-TIHETVVV">
									Frequency
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/trackers/" aria-current="false" class="astro-TIHETVVV">
									Trackers
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/data/pool/" aria-current="false" class="astro-TIHETVVV">
									Pool
								</a>
							</li>
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">Types</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/types/geometry/" aria-current="false" class="astro-TIHETVVV">
									Geometry
								</a>
							</li><li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/types/colour/" aria-current="false" class="astro-TIHETVVV">
									Colour
								</a>
							</li>
					</ul>
				</div>
			</li><li class="astro-TIHETVVV">
				<div class="nav-group astro-TIHETVVV">
					<h2 class="nav-group-title astro-TIHETVVV">IO</h2>
					<ul class="astro-TIHETVVV">
						<li class="nav-link astro-TIHETVVV">
								<a href="/ixfx-docs/io/espruino/" aria-current="false" class="astro-TIHETVVV">
									Espruino
								</a>
							</li>
					</ul>
				</div>
			</li>
	</ul>
</nav>

<script>
	window.addEventListener('DOMContentLoaded', (event) => {
		var target = document.querySelector('[aria-current="page"]');
		if (target && target.offsetTop > window.innerHeight - 100) {
			document.querySelector('.nav-groups').scrollTop = target.offsetTop;
		}
	});
</script>



			</aside>
			<div id="grid-main" class="astro-VOYEGVQR">
				<article id="article" class="content astro-AMOJLK4X">
	<section class="main-section astro-AMOJLK4X">
		<h1 class="content-title astro-AMOJLK4X" id="overview">State Machine</h1>
		<nav class="block sm:hidden astro-AMOJLK4X">
				<astro-root uid="ZOVQf3"><h2 class="heading">On this page</h2><ul><li class="header-link depth-2"><a href="#overview">Overview</a></li><li class="header-link depth-2"><a href="#machine-definition">Machine definition</a></li><li class="header-link depth-2"><a href="#why">Why?</a></li><li class="header-link depth-2"><a href="#playground">Playground</a></li><li class="header-link depth-2"><a href="#simple-usage">Simple usage</a></li><li class="header-link depth-2"><a href="#class-based-usage">Class-based usage</a></li><li class="header-link depth-2"><a href="#simple-machines">Simple machines</a></li><li class="header-link depth-2"><a href="#driver">Driver</a></li><li class="header-link depth-3"><a href="#demo">Demo</a></li></ul></astro-root>
			</nav>
		<div class="tip"><ul>
<li>API Reference <a href="ttps://clinth.github.io/ixfx/modules/Flow.StateMachine.html">StateMachine</a></li>
<li><a href="https://clinth.github.io/ixfx-demos/flow/">Online demos</a></li>
<li>Starter: <a href="https://github.com/ClintH/ixfx-demos/tree/main/flow/statemachine-starter">GitHub</a>, <a href="https://glitch.com/edit/#!/ixfx-starter-statemachine">Glitch</a>
</li></ul></div><p>A <em>state machine</em> allows for a controlled change from one state to another. It sets up a well-defined set of possible states and what transitions are possible between them. It's up to you to 'drive' the machine, telling it when to transition.</p><p>State machines are defined with a plain object. Properties list of possible states, with values being what state(s) that are possible to change to, or <em>null</em> if no further changes are possible.</p><h2 id="machine-definition">Machine definition</h2><p>An example of a simple state machine is a light switch. It has two states: <em>on</em> and <em>off</em>. When the light is <em>on</em>, the only other state is <em>off</em>. And vice-versa:</p><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">"off"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">off</span><span class="token operator">:</span> <span class="token string">"on"</span>
<span class="token punctuation">}</span></code></pre><p>With this machine definition, it would be illegal to have a state <code>dimmed</code>, or to turn it <code>off</code> when it is already <code>off</code>. In this case, the machine never reaches a final state, it can always oscillate between <code>on</code> / <code>off</code>. Note too that we can automatically and reliably advance the state of the machine, because each state indicates what follows.</p><p>It's possible to have several possible next states by using a string array:</p><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"off"</span><span class="token punctuation">,</span> <span class="token string">"half_bright"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">half_bright</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"on"</span><span class="token punctuation">,</span> <span class="token string">"off"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">off</span><span class="token operator">:</span> <span class="token string">"on"</span>
<span class="token punctuation">}</span></code></pre><p>The example below is intended to start with <code>plain</code> bread, with a few ways of getting to the eventual final state of <code>sprinkled_on_soup</code> or <code>eaten</code>. Once a machine is in its final state, it cannot change to another state unless it is <em>reset</em>.</p><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
  <span class="token literal-property property">plain</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"toasted"</span><span class="token punctuation">,</span> <span class="token string">"buttered"</span><span class="token punctuation">,</span> <span class="token string">"eaten"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">toasted</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"buttered"</span><span class="token punctuation">,</span> <span class="token string">"eaten"</span><span class="token punctuation">,</span> <span class="token string">"diced"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">buttered</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"eaten"</span><span class="token punctuation">,</span> <span class="token string">"marmaladed"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">marmaladed</span><span class="token operator">:</span> <span class="token string">"eaten"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">diced</span><span class="token operator">:</span> <span class="token string">"sprinkled_on_soup"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sprinkled_on_soup</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token literal-property property">eaten</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span></code></pre><h2 id="why">Why?</h2><p>Behaving according to a current state is a common pattern in programming interactivity. This is often solved by using different variables track state. A downside is that you have to be mindful what variables or conditions alter state as well as when and where to enforce rules about state changes.</p><p>A state machine therefore can help you catch errors and makes coding simpler when you know there are a fixed number of well-defined states to handle, and they are only activated according to a logic you have defined.</p><h2 id="playground">Playground</h2><p>Try out some state machines in this playground.</p><ol>
<li>Edit the description or choose a demo</li>
<li>Click <em>Use description</em> to load it have it checked for errors.</li>
<li>If successful, you can see available states. Select a state and then 'Change state'</li>
</ol><p>(Note that properties are enclosed in " marks here because it's represented as JSON)</p>

<div class="sxs astro-WPFLWN2H">
  <section id="dataDescr" class="dividerRight astro-WPFLWN2H">
    <section class="astro-WPFLWN2H">
      <div class="toolbar centered astro-WPFLWN2H">
        <label for="selDemoMachines" class="astro-WPFLWN2H">Load demo:</label>
        <select id="selDemoMachines" class="astro-WPFLWN2H">
          <option class="astro-WPFLWN2H">one</option>
        </select>
      </div>
    </section>
    <section class="astro-WPFLWN2H">
      <h2 class="astro-WPFLWN2H">1. Machine description</h2>
      <pre class="editable astro-WPFLWN2H" contenteditable id="jsonDescr"></pre>
      <div id="descrValidate" class="astro-WPFLWN2H"></div>

      <label class="astro-WPFLWN2H">
        Initial state:
        <select id="selDescrInitial" class="astro-WPFLWN2H">
          <option class="astro-WPFLWN2H"></option>
        </select>
      </label>
      <div class="toolbar centered astro-WPFLWN2H">
        <button id="btnSetDescr" class="astro-WPFLWN2H">2. Use description</button>
      </div>
    </section>
  </section>
  <section class="astro-WPFLWN2H">
    <section class="astro-WPFLWN2H">
      <h2 class="astro-WPFLWN2H">Control</h2>
      <select disabled size="3" id="selPossibleNext" class="astro-WPFLWN2H">
        <option class="astro-WPFLWN2H"></option>
      </select>
      <div class="toolbar astro-WPFLWN2H">
        <button disabled id="btnChangeState" class="astro-WPFLWN2H">3. Change state</button>
      </div>

      <div id="currentState" class="astro-WPFLWN2H"></div>
    </section>
    <section class="dividerTop astro-WPFLWN2H">
      <div id="dataStream" class="astro-WPFLWN2H"></div>
    </section>
  </section>
</div>
<h2 id="simple-usage">Simple usage</h2><div class="tip"><ul>
<li>API Reference <a href="https://clinth.github.io/ixfx/modules/Flow.StateMachine.html">StateMachine</a></li>
<li><a href="https://clinth.github.io/ixfx/modules/Flow.html">Online demos</a></li>
<li>Starter: <a href="https://github.com/ClintH/ixfx-demos/tree/main/flow/statemachine-starter">GitHub</a>, <a href="https://glitch.com/edit/#!/ixfx-starter-statemachine">Glitch</a>
</li></ul></div><p>A simple way of using the state machine is the functional, immutable approach. Create the machine with its <em>description</em> and <em>initial state</em>:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> machine <span class="token operator">=</span> StateMachine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">on</span><span class="token operator">:</span> <span class="token string">"off"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">off</span><span class="token operator">:</span> <span class="token string">"on"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"on"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>The machine description is a simple object that 1) lists all possible states (as its top-level properties), and 2) for each state, what other state(s) can be transitioned to, or <code>null</code> if it is a final state.</p><p>The following example has four possible states (<code>wakeup, sleep, coffee, breakfast, bike</code>). <code>sleep</code> can only transition to the <code>wakeup</code> state, while <code>wakeup</code> can transition to either <code>coffee</code> or <code>breakfast</code>.</p><p>Use <em>null</em> to signify the final state. Multiple states can terminate the machine if desired.</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#1</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StateMachine <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://unpkg.com/ixfx/dist/flow.js"</span>

<span class="token keyword">const</span> description <span class="token operator">=</span> <span class="token punctuation">{</span> 
 <span class="token literal-property property">sleep</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wakeup</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 <span class="token literal-property property">wakeup</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">coffee</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">breakfast</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token literal-property property">coffee</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bike</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 <span class="token literal-property property">breakfast</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bike</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 <span class="token literal-property property">bike</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> sm <span class="token operator">=</span> StateMachine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>description<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sleep</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>StateMachine.init</code> returns <a href="https://clinth.github.io/ixfx/types/Flow.StateMachine.MachineState.html"><code>MachineState</code></a> which captures the definition of the machine and its current state:</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#1</span>
<span class="token comment">// Current state</span>
sm<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// eg. 'bike'</span>
<span class="token comment">// List of unique states visited</span>
sm<span class="token punctuation">.</span>visited<span class="token punctuation">;</span> <span class="token comment">// eg. ['sleep', 'wakeup']</span>
<span class="token comment">// Original machine definition</span>
sm<span class="token punctuation">.</span>machine<span class="token punctuation">;</span> </code></pre><p>To attempt to change state, use <a href="https://clinth.github.io/ixfx/functions/Flow.StateMachine.to.html"><code>StateMachine.to</code></a></p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#1</span>
<span class="token comment">// Transition existing machine to state 'wakeup'</span>
sm <span class="token operator">=</span> StateMachine<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>sm<span class="token punctuation">,</span> <span class="token string">'wakeup'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
sm<span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token comment">// 'wakeup'</span></code></pre><p>If this is a legal transition, you'll get a new <code>MachineState</code> object. If not, an exception will be thrown. Note that the state is immutable - a transition results in a new object.</p><p>Here are some helper functions:</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#1</span>
<span class="token comment">// String array of possible next states</span>
StateMachine<span class="token punctuation">.</span><span class="token function">possible</span><span class="token punctuation">(</span>sm<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Returns _true_ if state machine cannot transition further</span>
StateMachine<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span>sm<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Try to automatically move to next state</span>
sm <span class="token operator">=</span> StateMachine<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>sm<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="class-based-usage">Class-based usage</h2><p>ixfx has a class <a href="https://clinth.github.io/ixfx/classes/Flow.StateMachine.WithEvents.html"><code>StateMachine.WithEvents</code></a> which wraps the functional implementation described above and also provides events for listening for event changes.</p><p>The same format is used to define possible transitions. Now there's an mutable object, so <code>const</code> can be used:</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#2</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StateMachine <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://unpkg.com/ixfx/dist/flow.js"</span>
<span class="token keyword">const</span> description <span class="token operator">=</span> <span class="token punctuation">{</span> 
 <span class="token literal-property property">sleep</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wakeup</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 <span class="token literal-property property">wakeup</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">coffee</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">breakfast</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token literal-property property">coffee</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bike</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 <span class="token literal-property property">breakfast</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bike</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
 <span class="token literal-property property">bike</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateMachine<span class="token punctuation">.</span>WithEvents</span><span class="token punctuation">(</span>description<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">initial</span><span class="token operator">:</span> <span class="token string">"sleep"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Change the state by name:</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#2</span>
sm<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">wakeup</span><span class="token template-punctuation string">`</span></span></code></pre><p>In some cases, you might want to ask the machine to transition to its next possible state, regardless of its current state. If multiple states are possible, it will use the first one.</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#2</span>
sm<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Reset the machine back to its initial state with <code>reset()</code>. This is the only way to continue after reaching the final state.</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#2</span>
sm<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Check status</p><pre class="language-js"><code class="language-js"><span class="token keyword">if</span> <span class="token punctuation">(</span>sm<span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">coffee</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token operator">...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>sm<span class="token punctuation">.</span>isDone<span class="token punctuation">)</span> <span class="token operator">...</span></code></pre><p>The <code>change</code> event is fired whenever state changes, and <code>stop</code> when the machine reaches a final state.</p><pre class="language-js"><code class="language-js">sm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">change</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">State change from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>evt<span class="token punctuation">.</span>priorState<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> -> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>evt<span class="token punctuation">.</span>newState<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Prints for example:</span>
 <span class="token comment">// State change from wakeup -> breakfast</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

sm<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">stop</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Machine has finished in state: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>evt<span class="token punctuation">.</span>newState<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="simple-machines">Simple machines</h2><p><a href="https://clinth.github.io/ixfx/functions/Flow.StateMachine.fromList.html"><code>StateMachine.fromList</code></a> creates a machine that steps through a series of states and then terminates.</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#3</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> StateMachine <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://unpkg.com/ixfx/dist/flow.js"</span>
<span class="token comment">// Machine that can go: init -> one -> two -> three -> [end]</span>
<span class="token keyword">const</span> sm1 <span class="token operator">=</span> StateMachine<span class="token punctuation">.</span><span class="token function">fromList</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">init</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">one</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">two</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">three</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Once in the 'three' state, will be considered <em>done</em>, since there is no possible transition from there.</p><p><a href="https://clinth.github.io/ixfx/functions/Flow.StateMachine.bidirectionalFromList.html"><code>StateMachine.bidirectionalFromList</code></a> is the same idea, but allow back-and-forth between states.</p><pre class="language-js"><code class="language-js"><span class="token comment">// repl-pad#3</span>
<span class="token comment">// Machine that can go: init &lt;-> one &lt;-> two &lt;-> three</span>
<span class="token keyword">const</span> sm2 <span class="token operator">=</span> StateMachine<span class="token punctuation">.</span><span class="token function">bidirectionalFromList</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">init</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">one</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">two</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">three</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>In the above example, <code>sm2</code> will never be <em>done</em>, because it's always possible for it to transition to some state.</p><h2 id="driver">Driver</h2><div class="tip"><ul>
<li>API Reference <a href="https://clinth.github.io/ixfx/functions/Flow.StateMachine.driver.html">StateMachine.driver</a></li>
<li><a href="https://github.com/ClintH/ixfx-demos/tree/main/flow/statemachine-regions">Example code</a>, <a href="https://clinth.github.io/ixfx-demos/flow/statemachine-regions/">Online demo</a></li>
<li><a href="https://glitch.com/edit/#!/ixix-state-machines-driver?path=index.html%3A1%3A0">Glitch example</a></li>
</ul></div><p>When using state machines, it's common to have a big <code>switch</code> statement (or lots of <code>if</code>s) to alter behaviour depending on the current state. Very often, these behaviours in turn trigger a state change. Since this is such a common pattern, the
<a href="https://clinth.github.io/ixfx/functions/Flow.StateMachine.driver.html"><code>StateMachine.driver</code></a> makes this a little simpler.</p><p>With it, you set up <em>state handlers</em> for different states and guiding the machine to subsequent states.</p><p>Each handler has an <code>if</code> field, a single string or array of strings corresponding to the state(s) that handler applies to. While one handler can handle multiple different states, there can't be multiple handlers per state.</p><p>The other part of the handler is <code>then</code> field. At its simplest, it is an object that tells what state to transition to, for example:</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">sleeping</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// If we're in the 'sleeping' state</span>
  <span class="token literal-property property">then</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'walking'</span> <span class="token punctuation">}</span> <span class="token comment">// Go to 'walking' state</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><p>It could alternatively be an array of functions, which return the same kind of object. When the handler is run, it executes these functions to determine what to do. Functions defined under <code>then</code> don't have to return a value - they could just be things you want to run when the state machine is in that state.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">walking</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>  <span class="token comment">// If we're in the 'walking' state</span>
  <span class="token literal-property property">then</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>  <span class="token comment">// Randomly either go to 'resting' or 'running' state next</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'resting'</span> <span class="token punctuation">}</span>
      <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'running'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span></code></pre><p>Once we have the state machine and the handlers, the driver can be initialised:</p><pre class="language-js"><code class="language-js"><span class="token comment">// Set up driver (note the use of await for both lines)</span>
<span class="token keyword">const</span> driver <span class="token operator">=</span> <span class="token keyword">await</span> StateMachine<span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span>states<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// To take action based on the current state, call .run():</span>
<span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>Here's a complete example:</p><pre class="language-js"><code class="language-js"><span class="token comment">// States</span>
<span class="token keyword">const</span> states <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">sleeping</span><span class="token operator">:</span> <span class="token string">'waking'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">waking</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'resting'</span><span class="token punctuation">,</span><span class="token string">'sleeping'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">resting</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'sleeping'</span><span class="token punctuation">,</span> <span class="token string">'walking'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">walking</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'running'</span><span class="token punctuation">,</span> <span class="token string">'resting'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">running</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'walking'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> handlers <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> 
    <span class="token comment">// State is 'sleeping'</span>
    <span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">'sleeping'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">then</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> 
    <span class="token comment">// State is 'waking'</span>
    <span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">'waking'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">then</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'resting'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'sleeping'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// Set up driver</span>
<span class="token keyword">const</span> driver <span class="token operator">=</span> <span class="token keyword">await</span> StateMachine<span class="token punctuation">.</span><span class="token function">driver</span><span class="token punctuation">(</span>states<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// To take action based on the current state, call .run():</span>
<span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Check current state</span>
driver<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// eg. 'resting'</span>

<span class="token comment">// Manually transition state</span>
driver<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token string">'walking'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>So far, handlers have returned an object describing what state to transition. Instead of hardcoding the state, you can use <code>{ next: true }</code> to transition to next available state. An alternative is <code>{ reset: true }</code>. When that is returned, the machine goes back to its initial state.</p><p>Each result can also have a <code>score</code> field. This is only useful if you have several results under <code>then</code>. By default, the highest scoring result determines what happens.</p><p>With this in mind, we can re-write the earlier example, assigning random scores for each possible next state:</p><pre class="language-js"><code class="language-js"><span class="token operator">...</span>
  <span class="token punctuation">{</span> 
    <span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">'waking'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">then</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// Two functions, each returns a result with a random score each time they are executed</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>  <span class="token punctuation">{</span> <span class="token literal-property property">score</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'resting'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>  <span class="token punctuation">{</span> <span class="token literal-property property">score</span><span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'sleeping'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span></code></pre><p>In practice you might want to weight the random values so one choice is more or less likely than another. See <a href="../gen/random.md">Random</a> for more on that.</p><p>Each handler also has an optional <code>resultChoice</code> field, which can be 'first', 'highest', 'lowest' or 'random'. By default, 'highest' is used, picking the highest scoring result. We could just as well use <code>resultChoice: 'random'</code> to evenly pick between choices.</p><pre class="language-js"><code class="language-js"><span class="token operator">...</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token operator">:</span> <span class="token string">'waking'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">resultChoice</span><span class="token operator">:</span> <span class="token string">'random'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">then</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'resting'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> <span class="token literal-property property">next</span><span class="token operator">:</span> <span class="token string">'sleeping'</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token operator">...</span></code></pre><p>When calling <code>driver.run()</code>, a result is returned with some status information.</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> driver<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
result<span class="token punctuation">.</span>value<span class="token punctuation">;</span>   <span class="token comment">// state at the end of .run()</span>
result<span class="token punctuation">.</span>visited<span class="token punctuation">;</span> <span class="token comment">// string array of unique states that have been visited</span>
result<span class="token punctuation">.</span>machine<span class="token punctuation">;</span> <span class="token comment">// original machine description</span></code></pre><h3 id="demo">Demo</h3><p>In the demo below, the driver is used to autonomously change states based on an 'energy' level, also affected by current activity.</p><demo-element><template shadowroot="open"><style>
  :host {
    display: block;
    --black: hsl(206, 11%, 12%);
    --white: hsl(206, 11%, 82%);

    --light-accent: hsl(217, 48%, 55%);
    --light-accent-text:hsl(217, 38%, 45%);
    --light-accent-bold:hsl(217, 100%, 45%);

    --dark-accent: hsl(217, 48%, 75%);
    --dark-accent-text:hsl(217, 78%, 75%);
    --dark-accent-bold:hsl(217, 78%, 75%);

    --dark-bg: hsl(229, 20%, 20%);
    --dark-bg-dim: hsl(231, 21%, 29%);
    --dark-fg: hsl(231, 28%, 73%);
    --dark-fg-bright: hsl(231, 28%, 82%);
    --dark-fgDim: hsl(231, 12%, 50%);
  
    --dark-yellow: hsl(39, 100%, 71%);
    --dark-purple: hsl(276, 68%, 75%);
    --dark-blue: hsl(197, 100%, 77%);
    --dark-green: hsl(68, 55%, 60%);
    
    --light-bg: hsl(0, 0%, 98%);
    --light-bg-dim: hsl(194, 16%, 94%);
    --light-fg: hsl(200, 16%, 62%);
    --light-fgDim: hsl(200, 16%, 32%);
    --light-fg-bright: hsl(200, 16%, 92%);

    --light-yellow: hsl(39, 100%, 59%);
    --light-purple: hsl(256, 90%, 65%);
    --light-blue: hsl(217, 38%, 55%);
    --light-green: hsl(85, 40%, 54%);

    --yellow: red;
    --radius: 1em;
    --padding: 0.3em;
    --padding-text: 0.8em;

    --divider: red;
    --light-external-link: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjBweCIgeT0iMHB4Igp3aWR0aD0iMzAiIGhlaWdodD0iMzAiCnZpZXdCb3g9IjAgMCAzMCAzMCIKc3R5bGU9IiBmaWxsOiMwMDAwMDA7Ij48cGF0aCBkPSJNIDI1Ljk4MDQ2OSAyLjk5MDIzNDQgQSAxLjAwMDEgMS4wMDAxIDAgMCAwIDI1Ljg2OTE0MSAzIEwgMjAgMyBBIDEuMDAwMSAxLjAwMDEgMCAxIDAgMjAgNSBMIDIzLjU4NTkzOCA1IEwgMTMuMjkyOTY5IDE1LjI5Mjk2OSBBIDEuMDAwMSAxLjAwMDEgMCAxIDAgMTQuNzA3MDMxIDE2LjcwNzAzMSBMIDI1IDYuNDE0MDYyNSBMIDI1IDEwIEEgMS4wMDAxIDEuMDAwMSAwIDEgMCAyNyAxMCBMIDI3IDQuMTI2OTUzMSBBIDEuMDAwMSAxLjAwMDEgMCAwIDAgMjUuOTgwNDY5IDIuOTkwMjM0NCB6IE0gNiA3IEMgNC45MDY5MzcyIDcgNCA3LjkwNjkzNzIgNCA5IEwgNCAyNCBDIDQgMjUuMDkzMDYzIDQuOTA2OTM3MiAyNiA2IDI2IEwgMjEgMjYgQyAyMi4wOTMwNjMgMjYgMjMgMjUuMDkzMDYzIDIzIDI0IEwgMjMgMTQgTCAyMyAxMS40MjE4NzUgTCAyMSAxMy40MjE4NzUgTCAyMSAxNiBMIDIxIDI0IEwgNiAyNCBMIDYgOSBMIDE0IDkgTCAxNiA5IEwgMTYuNTc4MTI1IDkgTCAxOC41NzgxMjUgNyBMIDE2IDcgTCAxNCA3IEwgNiA3IHoiPjwvcGF0aD48L3N2Zz4=') no-repeat left top;
    --dark-external-link: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjBweCIgeT0iMHB4Igp3aWR0aD0iMzAiIGhlaWdodD0iMzAiCnZpZXdCb3g9IjAgMCAxNzIgMTcyIgpzdHlsZT0iIGZpbGw6IzAwMDAwMDsiPjxnIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0ibm9uemVybyIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIHN0cm9rZS1saW5lY2FwPSJidXR0IiBzdHJva2UtbGluZWpvaW49Im1pdGVyIiBzdHJva2UtbWl0ZXJsaW1pdD0iMTAiIHN0cm9rZS1kYXNoYXJyYXk9IiIgc3Ryb2tlLWRhc2hvZmZzZXQ9IjAiIGZvbnQtZmFtaWx5PSJub25lIiBmb250LXdlaWdodD0ibm9uZSIgZm9udC1zaXplPSJub25lIiB0ZXh0LWFuY2hvcj0ibm9uZSIgc3R5bGU9Im1peC1ibGVuZC1tb2RlOiBub3JtYWwiPjxwYXRoIGQ9Ik0wLDE3MnYtMTcyaDE3MnYxNzJ6IiBmaWxsPSJub25lIj48L3BhdGg+PGcgZmlsbD0iI2ZmZmZmZiI+PHBhdGggZD0iTTE0OC45NTQ2OSwxNy4xNDQwMWMtMC4yMTM2NCwwLjAwNjc1IC0wLjQyNjczLDAuMDI1NDQgLTAuNjM4MjgsMC4wNTU5OWgtMzMuNjQ5NzRjLTIuMDY3NjUsLTAuMDI5MjQgLTMuOTkwODcsMS4wNTcwOSAtNS4wMzMyMiwyLjg0M2MtMS4wNDIzNiwxLjc4NTkyIC0xLjA0MjM2LDMuOTk0NzQgMCw1Ljc4MDY2YzEuMDQyMzYsMS43ODU5MiAyLjk2NTU4LDIuODcyMjUgNS4wMzMyMiwyLjg0M2gyMC41NTkzOGwtNTkuMDEzMDIsNTkuMDEzMDJjLTEuNDk3NzgsMS40MzgwMiAtMi4xMDExMywzLjU3MzQgLTEuNTc3MzUsNS41ODI2YzAuNTIzNzgsMi4wMDkyIDIuMDkyODQsMy41NzgyNiA0LjEwMjA0LDQuMTAyMDRjMi4wMDkyLDAuNTIzNzggNC4xNDQ1OCwtMC4wNzk1NyA1LjU4MjYsLTEuNTc3MzVsNTkuMDEzMDIsLTU5LjAxMzAydjIwLjU1OTM4Yy0wLjAyOTI0LDIuMDY3NjUgMS4wNTcwOSwzLjk5MDg3IDIuODQzLDUuMDMzMjJjMS43ODU5MiwxLjA0MjM2IDMuOTk0NzQsMS4wNDIzNiA1Ljc4MDY2LDBjMS43ODU5MiwtMS4wNDIzNiAyLjg3MjI1LC0yLjk2NTU4IDIuODQzLC01LjAzMzIydi0zMy42NzIxNGMwLjIzMTExLC0xLjY3MDc2IC0wLjI4NTExLC0zLjM1ODUzIC0xLjQxMTI5LC00LjYxNDE1Yy0xLjEyNjE3LC0xLjI1NTYyIC0yLjc0ODA2LC0xLjk1MTcyIC00LjQzNDAyLC0xLjkwMzA0ek0zNC40LDQwLjEzMzMzYy02LjI2Njg5LDAgLTExLjQ2NjY3LDUuMTk5NzcgLTExLjQ2NjY3LDExLjQ2NjY3djg2YzAsNi4yNjY4OSA1LjE5OTc3LDExLjQ2NjY3IDExLjQ2NjY3LDExLjQ2NjY3aDg2YzYuMjY2ODksMCAxMS40NjY2NywtNS4xOTk3NyAxMS40NjY2NywtMTEuNDY2Njd2LTU3LjMzMzMzdi0xNC43ODEyNWwtMTEuNDY2NjcsMTEuNDY2Njd2MTQuNzgxMjV2NDUuODY2NjdoLTg2di04Nmg0NS44NjY2N2gxMS40NjY2N2gzLjMxNDU4bDExLjQ2NjY3LC0xMS40NjY2N2gtMTQuNzgxMjVoLTExLjQ2NjY3eiI+PC9wYXRoPjwvZz48L2c+PC9zdmc+') no-repeat left top;
  }

  .icon {
    display: inline-block;
    padding-left: 1.4em;
    padding-right: 1.2em;
  }

  .controls {
    display: flex;
    justify-content: center;
  }

  .controls.wrappable {
    flex-wrap: wrap;
  }

  .controls .vertical {
    display: flex;
    flex-direction: column;
  }

  .controls h2 {
   
    text-align: center;
  }

  .controls label {
    display: flex;
    flex-direction: column;
    font-size: 80%;
    user-select: none;
  }

  .icon-external-link {
    background: var(--external-link);
    background-size: 1.2em;
  }

  a.icon:link {
    text-decoration: none;
  }
  a.icon:visited, a.icon:link {
    color: var(--fg);
  }

  iframe {
    border: none;
    margin: 0;
    padding: 0;
  }
  
  button, .toolbar .radios label {
    border: 0;
    padding: 0.5em 1em;
    font-size: 1rem;
    align-items: center;
    gap: 0.25em;
    border-radius: 99em;
    color: var(--fg-contrast-dim);
    background-color: var(--bg-contrast);
    transition: color 0.3s ease-out;
    cursor: pointer;
    user-select: none;
  }
  
  button:hover {
    color: var(--fg-contrast);
    transition: color 0.3s ease-in;
  }

  button[disabled], button[disabled]:hover {
    opacity: 0.6;
    background-color: var(--theme-code-inline-bg);
    cursor: default;
  }

  .toolbar {
    display: flex;
    margin: 0.5em;
    flex-wrap: wrap;
  }

  .toolbar.rightJustify {
    justify-content: flex-end;
   
  }

  .toolbar.centered {
    justify-content: center;
  }
  .toolbar.vertical {
    flex-direction: column;
    justify-content: center;
  }
  
  .toolbar input {
    min-width: 3em;
    margin-right: 1vw;
    margin-left: 1vw;
  }
  .vertical input {
    margin-left: 0;
  }
  .toolbar.mini, .toolbar.mini>button {
    font-size: 80%;
  }
  .toolbar > * {
    margin-left: var(--padding);
    margin-right: var(--padding);
  }

  .toolbar.vertical > * {
    margin-top: var(--padding);
    margin-bottom: var(--padding);
  }

  .radios input[type="radio"] {
    opacity: 0;
    position: fixed;
    width: 0;
  }

  .radios label {
    display: inline-block;
    opacity: 0.5;
    font-size: 80% !important;
    transition: all 0.3s ease-in;
  }

  .radios label:hover {
    opacity: 0.8;
    transition: opacity 0.3s ease-in;
  }
  
  .radios input[type="radio"]:checked + label {
    background-color: var(--bg-contrast);
    font-size: 100%;
    opacity: 1;
    transition: all 0.3s ease-in;
  }

  .radios input[type="radio"]:focus + label {
    border: 1px solid var(--fg);
  }
  
  .icon {
    opacity: 0.6;
    transition: opacity 0.5s ease-out;
  }
  .icon:hover {
    opacity: 1;
    transition: opacity 0.3s ease-in;
  }


  @media (prefers-color-scheme: dark) {
    :host {
      --bg-mono: var(--black);
      --bg: var(--dark-bg);
      --bg-dim: var(--dark-bg-dim);

      --divider: hsl(229, 30%, 30%);

      --accent: var(--dark-accent);
      --accent-text: var(--dark-accent-text);
      --accent-bold: var(--dark-accent-bold);

      --fg: var(--dark-fg);
      --fg-mono: var(--dark-fgDim);
      --fgDim: var(--dark-fgDim);
      --fg-bright: var(--dark-fg-bright);
      
      --purple: var(--dark-purple);
      --green: var(--dark-green);
      --blue: var(--dark-blue);

      --external-link: var(--dark-external-link);
    }
  }

  
  @media (prefers-color-scheme: light) {
    :host {
    --bg-mono: var(--white);
    --bg: var(--light-bg);
    --bg-dim: var(--light-bg-dim);
    
    --divider: hsl(193, 10%, 84%);

    --accent: var(--light-accent);
    --accent-bold: var(--light-accent-bold);
    --accent-text: var(--light-accent-text);

    --fg: var(--light-fg);
    --fg-mono: var(--light-fgDim);
    --fgDim: var(--light-fgDim);
    --fg-bright: var(--light-fg-bright);
    --purple: var(--light-purple);
    --green: var(--light-green);
    --blue: var(--light-blue);

    --bg-contrast: hsl(200, 16%, 92%);
    --fg-contrast: hsl(200, 16%, 22%);
    --fg-contrast-dim: hsl(200, 16%, 62%);

    --external-link: var(--light-external-link);
    }
  }

    :host {
      display: block;
    }
    .container {
      border: 1px solid black;
      padding: 0.5em;
      border-radius: 3px;
      background-color: var(--bg-mono);
      color: var(--fg-mono);
      display:flex;
      margin-top: 1em;
      margin-bottom: 1em;
      flex-direction: column;
      height: 100%;
      width: 100%;
    }
    .toolbar a.icon:visited, .toolbar a.icon:link {
      color: var(--fg-mono);
    }

    .toolbar {
      opacity: 0.3;
      transition: opacity 1s ease-out;
    }
    .titleBar:hover .toolbar {
      opacity: 1.0;
      transition: opacity 0.3s ease-in;
    }
    .titleBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 0.5em;
    }

    iframe {
      flex-grow: 1;
    }
    </style><!--lit-part Hjhn8vKCdng=-->
			<div class="container">
        <div class="titleBar">
          <div><!--lit-part-->State machine driver<!--/lit-part--></div>
          <div class="toolbar">
            <a class="icon icon-external-link" title="View source" target="_blank" href="https://github.com/ClintH/ixfx-demos/tree/main//flow/statemachine-agent/"><!--lit-node 5-->Source</a> 
            <a class="icon icon-external-link" title="Open demo in new window" target="_blank" href="https://clinth.github.io/ixfx-demos/flow/statemachine-agent/"><!--lit-node 6-->Open</a> 
          </div>
        </div>

        <iframe src="https://clinth.github.io/ixfx-demos/flow/statemachine-agent/"><!--lit-node 7--></iframe>
      </div>
		<!--/lit-part--></template></demo-element>
	</section>
	<nav class="block sm:hidden astro-AMOJLK4X">
		
<ul class="astro-WOEIVG5E">
</ul>
<div style="margin: 2rem 0; text-align: center;" class="astro-WOEIVG5E">
	<astro-root uid="1Gmxo9"><div class="theme-toggle"><label class><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd"></path></svg><input type="radio" name="theme-toggle" value="light" title="Use light theme" aria-label="Use light theme" /></label><label class><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg><input type="radio" name="theme-toggle" value="dark" title="Use dark theme" aria-label="Use dark theme" /></label></div></astro-root>
</div>



	</nav>
</article>



			</div>
			<aside id="grid-right" class="grid-sidebar astro-VOYEGVQR" title="Table of Contents">
				<nav class="sidebar-nav astro-XPZS3NBI" aria-labelledby="grid-right">
	<div class="sidebar-nav-inner astro-XPZS3NBI">
		<astro-root uid="ZOVQf3"><h2 class="heading">On this page</h2><ul><li class="header-link depth-2"><a href="#overview">Overview</a></li><li class="header-link depth-2"><a href="#machine-definition">Machine definition</a></li><li class="header-link depth-2"><a href="#why">Why?</a></li><li class="header-link depth-2"><a href="#playground">Playground</a></li><li class="header-link depth-2"><a href="#simple-usage">Simple usage</a></li><li class="header-link depth-2"><a href="#class-based-usage">Class-based usage</a></li><li class="header-link depth-2"><a href="#simple-machines">Simple machines</a></li><li class="header-link depth-2"><a href="#driver">Driver</a></li><li class="header-link depth-3"><a href="#demo">Demo</a></li></ul></astro-root>
		
<ul class="astro-WOEIVG5E">
</ul>
<div style="margin: 2rem 0; text-align: center;" class="astro-WOEIVG5E">
	<astro-root uid="1Gmxo9"><div class="theme-toggle"><label class><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd"></path></svg><input type="radio" name="theme-toggle" value="light" title="Use light theme" aria-label="Use light theme" /></label><label class><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg><input type="radio" name="theme-toggle" value="dark" title="Use dark theme" aria-label="Use dark theme" /></label></div></astro-root>
</div>



	</div>
</nav>



			</aside>
		</main>
	</body>
</html>
