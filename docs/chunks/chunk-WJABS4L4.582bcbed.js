import{A as S,a7 as me,m as H,x as J,D as ge,a8 as we,T as pe,L as K,s as ye}from"./chunk-QOZ2BRCA.9bf98e98.js";import{i as C,n as w,S as L}from"./chunk-U4IZE4J2.1410a545.js";import{_ as g,a as n,b as T,d as l,c as x}from"./chunk-6SYKIMQH.63e605dc.js";import{q as A}from"./chunk-25KFP6OF.fcfc3207.js";import{a as X}from"./chunk-4X2SZKK7.4dbfee46.js";import{i as k,o as B,s as xe}from"./chunk-OE2F6QKM.34a70cb8.js";var be={};g(be,{Analysers:()=>U,Visualiser:()=>j});var U={};g(U,{Analyser:()=>F,basic:()=>qe,freq:()=>Me,peakLevel:()=>Te});var j={};g(j,{default:()=>Y});var D=class{constructor(e=void 0,t){n(this,"samples",0),n(this,"total",0),n(this,"min",0),n(this,"max",0),n(this,"id"),n(this,"resetAfterSamples"),this.id=e,this.resetAfterSamples=t}get avg(){return this.total/this.samples}resetAvg(e=null){e!==null&&(this.id=e),this.total=0,this.samples=0}reset(e=null){this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER,this.resetAvg(e)}seen(e){if(Number.isNaN(e))throw Error("Cannot add NaN");this.resetAfterSamples!==void 0&&this.samples>this.resetAfterSamples&&this.reset(),this.samples++,this.total+=e,this.min=Math.min(e,this.min),this.max=Math.max(e,this.max)}getMinMaxAvg(){return{min:this.min,max:this.max,avg:this.avg}}},Ee=(e,t)=>new D(e,t),Se=class extends D{constructor(e=void 0,t){super(e,t);n(this,"lastMark",0)}mark(){this.lastMark>0&&this.seen(window.performance.now()-this.lastMark),this.lastMark=window.performance.now()}},Ce=(e,t)=>new Se(e,t),Y=class{constructor(e,t){n(this,"freqMaxRange",200),n(this,"audio"),n(this,"parent"),n(this,"lastPointer",{x:0,y:0}),n(this,"pointerDown",!1),n(this,"pointerClicking",!1),n(this,"pointerClickDelayMs",100),n(this,"pointerDelaying",!1),n(this,"waveTracker"),n(this,"freqTracker"),n(this,"el"),this.audio=t,this.parent=e,this.waveTracker=new D("wave"),this.freqTracker=new D("freq"),e.innerHTML=`
    <section>
      <button id="rendererComponentToggle">\u{1F53C}</button>
      <div>
        <h1>Visualiser</h1>
        <div style="display:flex; flex-wrap: wrap">
          <div class="visPanel">
            <h2>Frequency distribution</h2>
            <br />
            <canvas id="rendererComponentFreqData" height="200" width="400"></canvas>
          </div>
          <div class="visPanel">
            <h2>Waveform</h2>
            <button id="rendererComponentWaveReset">Reset</button>
            <div>
              Press and hold on wave to measure
            </div>
            <br />
            <canvas id="rendererComponentWaveData" height="200" width="400"></canvas>
          </div>
        </div>
      </div>
    </section>
    `,this.el=e.children[0],document.getElementById("rendererComponentToggle")?.addEventListener("click",()=>{this.setExpanded(!this.isExpanded())}),this.el.addEventListener("pointermove",r=>this.onPointer(r)),this.el.addEventListener("pointerup",()=>{this.pointerDelaying=!1,this.pointerDown=!1}),this.el.addEventListener("pointerdown",()=>{this.pointerDelaying=!0,setTimeout(()=>{this.pointerDelaying&&(this.pointerDelaying=!1,this.pointerDown=!0)},this.pointerClickDelayMs)}),this.el.addEventListener("pointerleave",()=>{this.pointerDelaying=!1,this.pointerDown=!1}),document.getElementById("rendererComponentWaveReset")?.addEventListener("click",()=>{this.clear()})}renderFreq(e){if(!this.isExpanded()||!e)return;const t=document.getElementById("rendererComponentFreqData");if(t===null)throw new Error("Cannot find canvas element");const r=t.getContext("2d");if(r===null)throw new Error("Cannot create drawing context");const i=e.length,s=t.clientWidth,a=t.clientHeight;r.clearRect(0,0,s,a);const o=this.getPointerRelativeTo(t),c=s/i,d=S.minMaxAvg(e);for(let h=0;h<i;h++){if(!Number.isFinite(e[h]))continue;const f=(e[h]-d.min)/this.freqMaxRange,m=Math.abs(a*f),q=a-m,M=h/i*360,R=h*c;if(r.fillStyle="hsl("+M+", 100%, 50%)",o.y>0&&o.y<=a&&o.x>=R&&o.x<=R+c){this.freqTracker.id!==h.toString()&&this.freqTracker.reset(h.toString()),this.freqTracker.seen(e[h]);const P=this.freqTracker.getMinMaxAvg();r.fillStyle="black",this.audio&&r.fillText(`Frequency (${h}) at pointer: ${this.audio.getFrequencyAtIndex(h).toLocaleString("en")} - ${this.audio.getFrequencyAtIndex(h+1).toLocaleString("en")}`,2,10),r.fillText(`Raw value: ${e[h].toFixed(2)}`,2,20),r.fillText(`Min: ${P.min.toFixed(2)}`,2,40),r.fillText(`Max: ${P.max.toFixed(2)}`,60,40),r.fillText(`Avg: ${P.avg.toFixed(2)}`,120,40)}r.fillRect(R,q,c,m)}}isExpanded(){const e=this.el.querySelector("div");if(e===null)throw new Error("contents div not found");return e.style.display===""}setExpanded(e){const t=this.el.querySelector("div"),r=this.el.querySelector("button");if(r===null)throw new Error("Button element not found");if(t===null)throw new Error("Contents element not found");e?(t.style.display="",r.innerText="\u{1F53C}"):(t.style.display="none",r.innerText="\u{1F53D}")}clear(){this.clearCanvas(document.getElementById("rendererComponentFreqData")),this.clearCanvas(document.getElementById("rendererComponentWaveData"))}clearCanvas(e){if(e===null)throw new Error("Canvas is null");const t=e.getContext("2d");if(t===null)throw new Error("Cannot create drawing context");t.fillStyle="white",t.fillRect(0,0,e.clientWidth,e.clientHeight)}renderWave(e,t=!0){if(!this.isExpanded()||!e)return;const r=document.getElementById("rendererComponentWaveData");if(r===null)throw new Error("Cannot find wave canvas");const i=r.getContext("2d");if(i===null)throw new Error("Cannot create drawing context for wave");const s=r.clientWidth,a=r.clientHeight,o=this.getPointerRelativeTo(r),c=20,d=60,h=e.length;i.fillStyle="white",i.fillRect(0,0,d,c);const u=s/h;i.fillStyle="rgba(255, 255, 255, 0.03)",i.fillRect(0,20,s,a),i.fillStyle="red",t?i.fillRect(0,a/2,s,1):i.fillRect(0,a-1,s,1),i.lineWidth=1,i.strokeStyle="black",i.beginPath();let f=0;for(let m=0;m<h;m++){const q=e[m]*a,M=t?a/2-q:a-q;m===0?i.moveTo(f,M):i.lineTo(f,M),f+=u,this.pointerDown&&this.waveTracker.seen(e[m])}if(i.lineTo(s,t?a/2:a),i.stroke(),this.pointerDown){const m=this.waveTracker.getMinMaxAvg();i.fillStyle="rgba(255,255,0,1)",i.fillRect(d,0,150,20),i.fillStyle="black",i.fillText("Min: "+m.min.toFixed(2),60,10),i.fillText("Max: "+m.max.toFixed(2),110,10),i.fillText("Avg: "+m.avg.toFixed(2),160,10)}else this.waveTracker.reset();o.y>0&&o.y<=a&&o.x>=0&&o.x<=s&&(i.fillStyle="black",i.fillText("Level: "+(1-o.y/a).toFixed(2),2,10))}getPointerRelativeTo(e){const t=e.getBoundingClientRect();return{x:this.lastPointer.x-t.left-window.scrollX,y:this.lastPointer.y-t.top-window.scrollY}}onPointer(e){this.lastPointer={x:e.pageX,y:e.pageY},e.preventDefault()}},qe=(e,t={})=>new F((r,i)=>{const s=new Float32Array(r.frequencyBinCount),a=new Float32Array(r.fftSize);r.getFloatFrequencyData(s),r.getFloatTimeDomainData(a),e(s,a,i)},t),Me=(e,t={})=>new F((r,i)=>{const s=new Float32Array(r.frequencyBinCount);r.getFloatFrequencyData(s),e(s,i)},t),Te=(e,t={})=>new F((r,i)=>{const s=new Float32Array(r.fftSize);r.getFloatTimeDomainData(s),e(S.maxFast(s),i)},t),E,p,F=class{constructor(e,t={}){if(n(this,"showVis"),n(this,"fftSize"),n(this,"smoothingTimeConstant"),T(this,E,!1),n(this,"debug"),T(this,p,!1),n(this,"visualiser"),n(this,"audioCtx"),n(this,"analyserNode"),n(this,"analyse"),this.showVis=t.showVis??!1,this.fftSize=t.fftSize??1024,this.debug=t.debug??!1,this.smoothingTimeConstant=t.smoothingTimeConstant??.8,C(this.fftSize,"positive","opts.fftSize"),w(this.smoothingTimeConstant,"percentage","opts.smoothingTimeConstant"),!me(this.fftSize))throw new Error(`fftSize must be a power of two from 32 to 32768 (${this.fftSize})`);if(this.fftSize<32)throw new Error("fftSize must be at least 32");if(this.fftSize>32768)throw new Error("fftSize must be no greater than 32768");this.analyse=e,this.paused=!1,this.init();const r=document.getElementById("audio-visualiser");if(r){const i=new Y(r,this);i.setExpanded(this.showVis),this.visualiser=i}}init(){if(l(this,p)){this.debug&&console.debug("Init already in progress");return}x(this,p,!0),navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{this.onMicSuccess(e)}).catch(e=>{x(this,p,!1),console.error(e)})}get paused(){return l(this,E)}set paused(e){e!==l(this,E)&&(x(this,E,e),e?this.debug&&console.log("Paused"):(this.debug&&console.log("Unpaused"),window.requestAnimationFrame(this.analyseLoop.bind(this))))}setup(e,t){const r=e.createAnalyser();return r.fftSize=this.fftSize,r.smoothingTimeConstant=this.smoothingTimeConstant,e.createMediaStreamSource(t).connect(r),r}onMicSuccess(e){try{const t=new AudioContext;t.addEventListener("statechange",()=>{this.debug&&console.log(`Audio context state: ${t.state}`)}),this.audioCtx=t,this.analyserNode=this.setup(t,e),window.requestAnimationFrame(this.analyseLoop.bind(this))}catch(t){x(this,p,!1),console.error(t)}}analyseLoop(){if(this.paused){this.debug&&console.log("Paused");return}const e=this.analyserNode;if(e===void 0){console.warn("Analyser undefined");return}try{this.analyse(e,this)}catch(t){console.error(t)}window.requestAnimationFrame(this.analyseLoop.bind(this))}getFrequencyRangeMax(e,t,r){const i=this.sliceByFrequency(e,t,r);return S.max(...i)}sliceByFrequency(e,t,r){const i=this.getIndexForFrequency(e),s=this.getIndexForFrequency(t);return r.slice(i,s)}getFrequencyAtIndex(e){const t=this.analyserNode,r=this.audioCtx;if(t===void 0)throw new Error("Analyser not available");if(r===void 0)throw new Error("Audio context not available");if(C(e,"positive","index"),e>t.frequencyBinCount)throw new Error(`Index ${e} exceeds frequency bin count ${t.frequencyBinCount}`);return e*r.sampleRate/(t.frequencyBinCount*2)}getIndexForFrequency(e){const t=this.analyserNode;if(t===void 0)throw new Error("Analyser not available");const r=t.context.sampleRate/2,i=Math.round(e/r*t.frequencyBinCount);return i<0?0:i>=t.frequencyBinCount?t.frequencyBinCount-1:i}};E=new WeakMap;p=new WeakMap;var Z={};g(Z,{byValueString:()=>te,getSorter:()=>re,minMaxAvg:()=>Re,sortByKey:()=>I,sortByValueNumber:()=>_,sortByValueString:()=>Fe});function z(e,t,r,i,s,a,o,c,d){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return r(t(e));case 4:return i(r(t(e)));case 5:return s(i(r(t(e))));case 6:return a(s(i(r(t(e)))));case 7:return o(a(s(i(r(t(e))))));case 8:return c(o(a(s(i(r(t(e)))))));case 9:return d(c(o(a(s(i(r(t(e))))))));default:for(var h=arguments[0],u=1;u<arguments.length;u++)h=arguments[u](h);return h}}var Ae=function(e){return function(t,r){return t===r||e(t,r)===0}},Q=function(e){return{equals:Ae(e),compare:function(t,r){return t===r?0:e(t,r)}}},W=function(e){return Q(function(t,r){return e.compare(r,t)})},V=function(e){return function(t){return Q(function(r,i){return t.compare(e(r),e(i))})}},ee={equals:function(e,t){return e===t}},$={equals:ee.equals,compare:function(e,t){return e<t?-1:e>t?1:0}};ee.equals,$.compare;var ke=function(e){return e.slice()},G=function(e){return function(t){return t.length<=1?ke(t):t.slice().sort(e.compare)}},Be={equals:function(e,t){return e===t}},N={equals:Be.equals,compare:function(e,t){return e<t?-1:e>t?1:0}},De=(e=!1)=>z(e?W(N):N,V(t=>t[0])),te=(e=!1)=>z(e?W(N):N,V(t=>t[1])),Ne=(e=!1)=>z(e?W($):$,V(t=>t[1])),I=(e=!1)=>G(De(e)),Fe=(e=!1)=>G(te(e)),_=(e=!1)=>G(Ne(e)),re=e=>{switch(e){case"value":return _(!1);case"valueReverse":return _(!0);case"key":return I(!1);case"keyReverse":return I(!0);default:throw new Error(`Unknown sorting value '${e}'. Expecting: value, valueReverse, key or keyReverse`)}},Re=(e,t)=>{t===void 0&&(t=i=>i[1]);const r=e.map(t);return H(r)},Pe={};g(Pe,{FrequencyMutable:()=>se,Normalise:()=>ie,frequencyMutable:()=>_e,intervalTracker:()=>Ce,movingAverage:()=>ze,movingAverageLight:()=>Le,tracker:()=>Ee});var ie={};g(ie,{array:()=>Ie,stream:()=>$e});var $e=(e,t)=>{let r=e??Number.MAX_SAFE_INTEGER,i=t??Number.MIN_SAFE_INTEGER;return s=>(r=Math.min(r,s),i=Math.max(i,s),J(s,r,i))},Ie=(e,t,r)=>{if(!Array.isArray(e))throw new Error("values param should be an array");const i=H(e),s=t??i.min,a=r??i.max;return e.map(o=>ge(J(o,s,a)))},v,y,se=class extends L{constructor(e=void 0){super();T(this,v,void 0),T(this,y,void 0),x(this,v,new Map),e===void 0&&(e=t=>{if(t===void 0)throw new Error("Cannot create key for undefined");return typeof t=="string"?t:JSON.stringify(t)}),x(this,y,e)}clear(){l(this,v).clear(),this.fireEvent("change",void 0)}keys(){return l(this,v).keys()}values(){return l(this,v).values()}toArray(){return Array.from(l(this,v).entries())}debugString(){let e="";for(const[t,r]of l(this,v).entries())e+=`${t}: ${r}, `;return e.endsWith(", ")?e.substring(0,e.length-2):e}frequencyOf(e){if(typeof e=="string")return l(this,v).get(e);const t=l(this,y).call(this,e);return l(this,v).get(t)}relativeFrequencyOf(e){let t;if(typeof e=="string")t=l(this,v).get(e);else{const i=l(this,y).call(this,e);t=l(this,v).get(i)}if(t===void 0)return;const r=this.minMaxAvg();return t/r.total}entries(){return Array.from(l(this,v).entries())}minMaxAvg(){return Z.minMaxAvg(this.entries())}entriesSorted(e="value"){return re(e)(this.entries())}add(...e){if(e===void 0)throw new Error("value parameter is undefined");e.map(l(this,y)).forEach(r=>{const i=l(this,v).get(r)??0;l(this,v).set(r,i+1)}),this.fireEvent("change",void 0)}};v=new WeakMap;y=new WeakMap;var _e=e=>new se(e),Le=(e=3)=>{C(e,"aboveZero","scaling");let t=0,r=0;return{add(s){return r++,t=t+(s-t)/Math.min(r,e),t},clear(){t=0,r=0},compute(){return t}}},ze=(e=100,t)=>{let r=A({capacity:e,discardPolicy:"older"});const i=()=>{r=A({capacity:e,discardPolicy:"older"})},s=()=>t===void 0?S.average(...r.data):S.averageWeighted(r.data,t);return{add:o=>(r.enqueue(o),s()),compute:s,clear:i}},We={};g(We,{count:()=>Oe,numericPercent:()=>He,numericRange:()=>ae,numericRangeRaw:()=>Ge,pingPong:()=>ne,pingPongPercent:()=>Ve});var Ve=function(e=.1,t,r,i,s=1e3){return t===void 0&&(t=0),r===void 0&&(r=1),i===void 0&&(i=t),w(e,"bipolar","interval"),w(r,"bipolar","end"),w(i,"bipolar","offset"),w(t,"bipolar","start"),ne(e,t,r,i,s)},ne=function*(e,t,r,i,s=1){if(t===void 0)throw new Error("Parameter 'lower' is undefined");if(e===void 0)throw new Error("Parameter 'interval' is undefined");if(r===void 0)throw new Error("Parameter 'upper' is undefined");if(Number.isNaN(e))throw new Error("interval parameter is NaN");if(Number.isNaN(t))throw new Error("lower parameter is NaN");if(Number.isNaN(r))throw new Error("upper parameter is NaN");if(Number.isNaN(i))throw new Error("upper parameter is NaN");if(t>=r)throw new Error("lower must be less than upper");if(e===0)throw new Error("Interval cannot be zero");const a=r-t;if(Math.abs(e)>=a)throw new Error(`Interval should be between -${a} and ${a}`);let o=e>0;if(r=Math.floor(r*s),t=Math.floor(t*s),e=Math.floor(Math.abs(e*s)),i===void 0?i=t:i=Math.floor(i*s),i>r||i<t)throw new Error(`Start (${i/s}) must be within lower (${t/s}) and upper (${r/s})`);let c=i;yield c/s;let d=!0;for(;;)c=c+(o?e:-e),o&&c>=r?(o=!1,c=r,c===r&&d&&(c=t,o=!0)):!o&&c<=t&&(o=!0,c=t,c===t&&d&&(c=r,o=!1)),yield c/s,d=!1},Ge=function*(e,t=0,r,i=!1){if(e<=0)throw new Error("Interval is expected to be above zero");r===void 0&&(r=Number.MAX_SAFE_INTEGER);let s=t;do for(;s<r;)yield s,s+=e;while(i)},ae=function*(e,t=0,r,i=!1,s){w(e,"nonZero");const a=e<0;if(r!==void 0){if(a&&t<r)throw new Error(`Interval of ${e} will never go from ${t} to ${r}`);if(!a&&t>r)throw new Error(`Interval of ${e} will never go from ${t} to ${r}`)}s=s??1e3,r===void 0?r=Number.MAX_SAFE_INTEGER:r*=s,e=e*s;do{let o=t*s;for(;!a&&o<=r||a&&o>=r;)yield o/s,o+=e}while(i)},Oe=function*(e,t=0){if(C(e,"","amount"),C(t,"","offset"),e===0)return;let r=0;do e<0?yield-r+t:yield r+t;while(r++<Math.abs(e)-1)},He=function(e=.01,t=!1,r=0,i=1){return w(e,"percentage","interval"),w(r,"percentage","start"),w(i,"percentage","end"),ae(e,r,i,t)},Je={};g(Je,{Bluetooth:()=>oe,Camera:()=>de,Espruino:()=>fe,Serial:()=>ve});var oe={};g(oe,{NordicBleDevice:()=>ue,defaultOpts:()=>b});var ce=class{constructor(){n(this,"enc",new TextEncoder),n(this,"dec",new TextDecoder("utf-8"))}toBuffer(e){return this.enc.encode(e)}fromBuffer(e){return this.dec.decode(e)}},he=class{constructor(e,t=`
`){this.onData=e,this.separator=t,n(this,"buffer",""),n(this,"stream")}clear(){this.buffer=""}writable(){return this.stream===void 0&&(this.stream=this.createWritable()),this.stream}createWritable(){const e=this;return new WritableStream({write(t){e.add(t)},close(){e.clear()}})}addImpl(e){const t=e.indexOf(this.separator);if(t<0)return this.buffer+=e,"";const r=e.substring(0,t);try{this.onData(this.buffer+r),e=e.substring(r.length+this.separator.length)}catch(i){console.warn(i)}return this.buffer="",e}add(e){for(;e.length>0;)e=this.addImpl(e)}},le=class{constructor(e,t=-1){this.onData=e,this.chunkSize=t,n(this,"paused",!1),n(this,"queue"),n(this,"writer"),n(this,"intervalMs"),n(this,"stream"),this.intervalMs=10,this.queue=A(),this.writer=ye(()=>this.onWrite(),this.intervalMs)}clear(){this.queue=A()}writable(){return this.stream===void 0&&(this.stream=this.createWritable()),this.stream}createWritable(){const e=this;return new WritableStream({write(t){e.add(t)},close(){e.clear()}})}async onWrite(){if(this.queue.isEmpty)return!1;if(this.paused)return console.warn("WriteBuffer.onWrite: paused..."),!0;const e=this.queue.dequeue();return e===void 0?!1:(await this.onData(e),!0)}add(e){this.chunkSize>0?this.queue.enqueue(...xe(e,this.chunkSize)):this.queue.enqueue(e),this.writer.start()}},Ke=class extends L{constructor(e,t){super();this.device=e,this.config=t,n(this,"states"),n(this,"codec"),n(this,"rx"),n(this,"tx"),n(this,"gatt"),n(this,"verboseLogging",!1),n(this,"rxBuffer"),n(this,"txBuffer"),this.verboseLogging=t.debug,this.txBuffer=new le(async r=>{await this.writeInternal(r)},t.chunkSize),this.rxBuffer=new he(r=>{this.fireEvent("data",{data:r})}),this.codec=new ce,this.states=new X("ready",{ready:"connecting",connecting:["connected","closed"],connected:["closed"],closed:"connecting"}),this.states.addEventListener("change",r=>{this.fireEvent("change",r),this.verbose(`${r.priorState} -> ${r.newState}`),r.priorState==="connected"&&(this.rxBuffer.clear(),this.txBuffer.clear())}),e.addEventListener("gattserverdisconnected",()=>{this.isClosed||(this.verbose("GATT server disconnected"),this.states.state="closed")}),this.verbose(`ctor ${e.name} ${e.id}`)}get isConnected(){return this.states.state==="connected"}get isClosed(){return this.states.state==="closed"}write(e){if(this.states.state!=="connected")throw new Error(`Cannot write while state is ${this.states.state}`);this.txBuffer.add(e)}async writeInternal(e){this.verbose(`writeInternal ${e}`);const t=this.tx;if(t===void 0)throw new Error("Unexpectedly without tx characteristic");try{await t.writeValue(this.codec.toBuffer(e))}catch(r){this.warn(r)}}disconnect(){this.states.state==="connected"&&this.gatt?.disconnect()}async connect(){const e=this.config.connectAttempts??3;this.states.state="connecting",this.verbose("connect");const t=this.device.gatt;if(t===void 0)throw new Error("Gatt not available on device");await K(async()=>{const r=await t.connect();this.verbose("Getting primary service");const i=await r.getPrimaryService(this.config.service);this.verbose("Getting characteristics");const s=await i.getCharacteristic(this.config.rxGattCharacteristic),a=await i.getCharacteristic(this.config.txGattCharacteristic);s.addEventListener("characteristicvaluechanged",o=>this.onRx(o)),this.rx=s,this.tx=a,this.gatt=t,this.states.state="connected",await s.startNotifications()},e,200)}onRx(e){if(this.rx===void 0)return;const r=e.target.value;if(r===void 0)return;let i=this.codec.fromBuffer(r.buffer);const s=k(i,19),a=k(i,17);a&&s<a&&(this.verbose("Tx plz start"),i=B(i,a,1),this.txBuffer.paused=!1),s&&s>a&&(this.verbose("Tx plz stop"),i=B(i,s,1),this.txBuffer.paused=!0),this.rxBuffer.add(i)}verbose(e){this.verboseLogging&&console.info(`${this.config.name} `,e)}log(e){console.log(`${this.config.name} `,e)}warn(e){console.warn(`${this.config.name} `,e)}},b={chunkSize:20,service:"6e400001-b5a3-f393-e0a9-e50e24dcca9e",txGattCharacteristic:"6e400002-b5a3-f393-e0a9-e50e24dcca9e",rxGattCharacteristic:"6e400003-b5a3-f393-e0a9-e50e24dcca9e",name:"NordicDevice",connectAttempts:5,debug:!1},ue=class extends Ke{constructor(e,t={}){super(e,{...b,...t})}},fe={};g(fe,{EspruinoDevice:()=>O,connect:()=>Ue,puck:()=>Xe});var O=class extends ue{constructor(e,t={}){super(e,t);n(this,"evalTimeoutMs"),this.evalTimeoutMs=t.evalTimeoutMs??5*1e3}async writeScript(e){this.write(`reset();
`),this.write(`${e}
`)}async eval(e,t={}){const r=t.timeoutMs??this.evalTimeoutMs,i=t.assumeExclusive??!0;if(typeof e!="string")throw new Error("code parameter should be a string");return new Promise((s,a)=>{const o=we(5),c=u=>{try{const f=JSON.parse(u.data);"reply"in f&&(f.reply===o?(h(),"result"in f&&s(f.result)):this.warn(`Expected reply ${o}, got ${f.reply}`))}catch(f){i?h(u.data):this.warn(f)}},d=u=>{u.newState!=="connected"&&h(`State changed to '${u.newState}', aborting`)};this.addEventListener("data",c),this.addEventListener("change",d);const h=pe(r,u=>{a(u)},()=>{this.removeEventListener("data",c),this.removeEventListener("change",d)});this.write(`Bluetooth.println(JSON.stringify({reply:"${o}", result:JSON.stringify(${e})}))
`)})}},Xe=async(e={})=>{const t=e.name??"Puck",r=e.debug??!1,i=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"Puck.js"},{services:[b.service]}],optionalServices:[b.service]}),s=new O(i,{name:t,debug:r});return await s.connect(),s},Ue=async()=>{const e=await navigator.bluetooth.requestDevice({filters:[{namePrefix:"Puck.js"},{namePrefix:"Pixl.js"},{namePrefix:"MDBT42Q"},{namePrefix:"RuuviTag"},{namePrefix:"iTracker"},{namePrefix:"Thingy"},{namePrefix:"Espruino"},{services:[b.service]}],optionalServices:[b.service]}),t=new O(e,{name:"Espruino"});return await t.connect(),t},de={};g(de,{dumpDevices:()=>je,start:()=>Ye});var je=async(e="videoinput")=>{(await navigator.mediaDevices.enumerateDevices()).forEach(r=>{r.kind===e&&(console.log(r.label),console.log(` Kind: ${r.kind}`),console.log(` Device id: ${r.deviceId}`))})},Ye=async(e={})=>{const t=document.createElement("VIDEO");t.style.display="none",document.body.appendChild(t);let r=()=>{};const i=()=>{try{r()}catch{}t.remove()};try{r=(await Ze(t,e)).dispose}catch(s){console.error(s),i();return}return{videoEl:t,dispose:i}},Ze=async(e,t={})=>{if(e===void 0)throw new Error("videoEl undefined");if(e===null)throw new Error("videoEl null");const r=t.facingMode??"user",i=t.max,s=t.min,a={audio:!1,video:{facingMode:r,width:{},height:{}}};i&&(a.video.width={max:i.width},a.video.height={max:i.height}),s&&(a.video.width={min:s.width},a.video.height={min:s.height});const o=()=>{console.log("Camera:dispose"),e.pause(),c.getTracks().forEach(f=>f.stop())},c=await navigator.mediaDevices.getUserMedia(a);e.srcObject=c;const d={videoEl:e,dispose:o};return new Promise((u,f)=>{e.addEventListener("loadedmetadata",()=>{e.play().then(()=>{u(d)}).catch(m=>{f(m)})})})},ve={};g(ve,{Device:()=>et});var Qe=class extends L{constructor(e={}){super();n(this,"states"),n(this,"codec"),n(this,"verboseLogging",!1),n(this,"name"),n(this,"connectAttempts"),n(this,"chunkSize"),n(this,"rxBuffer"),n(this,"txBuffer"),this.verboseLogging=e.debug??!1,this.chunkSize=e.chunkSize??1024,this.connectAttempts=e.connectAttempts??3,this.name=e.name??"JsonDevice",this.txBuffer=new le(async t=>{await this.writeInternal(t)},e.chunkSize),this.rxBuffer=new he(t=>{this.fireEvent("data",{data:t})}),this.codec=new ce,this.states=new X("ready",{ready:"connecting",connecting:["connected","closed"],connected:["closed"],closed:"connecting"}),this.states.addEventListener("change",t=>{this.fireEvent("change",t),this.verbose(`${t.priorState} -> ${t.newState}`),t.priorState==="connected"&&(this.rxBuffer.clear(),this.txBuffer.clear())})}get isConnected(){return this.states.state==="connected"}get isClosed(){return this.states.state==="closed"}write(e){if(this.states.state!=="connected")throw new Error(`Cannot write while state is ${this.states.state}`);this.txBuffer.add(e)}close(){this.states.state==="connected"&&this.onClosed()}async connect(){const e=this.connectAttempts;this.states.state="connecting",await this.onPreConnect(),await K(async()=>{await this.onConnectAttempt(),this.states.state="connected"},e,200)}onRx(e){const t=e.target.value;if(t===void 0)return;let r=this.codec.fromBuffer(t.buffer);const i=k(r,19),s=k(r,17);s&&i<s&&(this.verbose("Tx plz start"),r=B(r,s,1),this.txBuffer.paused=!1),i&&i>s&&(this.verbose("Tx plz stop"),r=B(r,i,1),this.txBuffer.paused=!0),this.rxBuffer.add(r)}verbose(e){this.verboseLogging&&console.info(`${this.name} `,e)}log(e){console.log(`${this.name} `,e)}warn(e){console.warn(`${this.name} `,e)}},et=class extends Qe{constructor(e={}){super(e);this.config=e,n(this,"port"),n(this,"tx"),n(this,"baudRate"),this.baudRate=e.baudRate??9600,e.name===void 0&&(super.name="Serial.Device"),this.rxBuffer.separator=`\r
`}async writeInternal(e){if(this.tx===void 0)throw new Error("tx not ready");try{this.tx.write(e)}catch(t){this.warn(t)}}onClosed(){try{this.port?.close()}catch(e){this.warn(e)}this.states.state="closed"}onPreConnect(){return Promise.resolve()}async onConnectAttempt(){let e={};const t={baudRate:this.baudRate};this.config.filters&&(e={filters:[...this.config.filters]}),this.port=await navigator.serial.requestPort(e),this.port.addEventListener("disconnect",o=>{this.close()}),await this.port.open(t);const r=this.port.writable,i=new TextEncoderStream;r!==null&&(i.readable.pipeTo(r),this.tx=i.writable.getWriter());const s=this.port.readable,a=new TextDecoderStream;s!==null&&(s.pipeTo(a.writable),a.readable.pipeTo(this.rxBuffer.writable()))}};export{We as G,Z as K,ie as N,_e as f,re as g};
