import{m as z,o as L,v as ee,A as b,N as te}from"./chunk-QIWUQGQJ.e6594f26.js";import{_ as m,a as A,c as p,d as u,b as o}from"./chunk-FQLUQVDZ.735c98e3.js";import{q as $}from"./chunk-QAZYUFOI.8a9663bc.js";import{S as re,n as v,i as S}from"./chunk-U4IZE4J2.68fe18db.js";var V={};m(V,{byValueString:()=>O,getSorter:()=>X,minMaxAvg:()=>ce,sortByKey:()=>R,sortByValueNumber:()=>_,sortByValueString:()=>le});function I(e,t,r,i,n,s,a,l,d){switch(arguments.length){case 1:return e;case 2:return t(e);case 3:return r(t(e));case 4:return i(r(t(e)));case 5:return n(i(r(t(e))));case 6:return s(n(i(r(t(e)))));case 7:return a(s(n(i(r(t(e))))));case 8:return l(a(s(n(i(r(t(e)))))));case 9:return d(l(a(s(n(i(r(t(e))))))));default:for(var c=arguments[0],g=1;g<arguments.length;g++)c=arguments[g](c);return c}}var ie=function(e){return function(t,r){return t===r||e(t,r)===0}},G=function(e){return{equals:ie(e),compare:function(t,r){return t===r?0:e(t,r)}}},D=function(e){return G(function(t,r){return e.compare(r,t)})},P=function(e){return function(t){return G(function(r,i){return t.compare(e(r),e(i))})}},H={equals:function(e,t){return e===t}},k={equals:H.equals,compare:function(e,t){return e<t?-1:e>t?1:0}};H.equals,k.compare;var ne=function(e){return e.slice()},B=function(e){return function(t){return t.length<=1?ne(t):t.slice().sort(e.compare)}},se={equals:function(e,t){return e===t}},N={equals:se.equals,compare:function(e,t){return e<t?-1:e>t?1:0}},ae=(e=!1)=>I(e?D(N):N,P(t=>t[0])),O=(e=!1)=>I(e?D(N):N,P(t=>t[1])),oe=(e=!1)=>I(e?D(k):k,P(t=>t[1])),R=(e=!1)=>B(ae(e)),le=(e=!1)=>B(O(e)),_=(e=!1)=>B(oe(e)),X=e=>{switch(e){case"value":return _(!1);case"valueReverse":return _(!0);case"key":return R(!1);case"keyReverse":return R(!0);default:throw new Error(`Unknown sorting value '${e}'. Expecting: value, valueReverse, key or keyReverse`)}},ce=(e,t)=>{t===void 0&&(t=i=>i[1]);const r=e.map(t);return z(r)},ue={};m(ue,{FrequencyMutable:()=>U,Normalise:()=>K,frequencyMutable:()=>de,movingAverage:()=>ve});var K={};m(K,{array:()=>fe,stream:()=>he});var he=(e,t)=>{let r=e??Number.MAX_SAFE_INTEGER,i=t??Number.MIN_SAFE_INTEGER;return n=>(r=Math.min(r,n),i=Math.max(i,n),L(n,r,i))},fe=(e,t,r)=>{if(!Array.isArray(e))throw new Error("values param should be an array");const i=z(e),n=t??i.min,s=r??i.max;return e.map(a=>ee(L(a,n,s)))},h,y,U=class extends re{constructor(e=void 0){super();A(this,h,void 0),A(this,y,void 0),p(this,h,new Map),e===void 0&&(e=t=>{if(t===void 0)throw new Error("Cannot create key for undefined");return typeof t=="string"?t:JSON.stringify(t)}),p(this,y,e)}clear(){u(this,h).clear(),this.fireEvent("change",void 0)}keys(){return u(this,h).keys()}values(){return u(this,h).values()}toArray(){return Array.from(u(this,h).entries())}debugString(){let e="";for(const[t,r]of u(this,h).entries())e+=`${t}: ${r}, `;return e.endsWith(", ")?e.substring(0,e.length-2):e}frequencyOf(e){if(typeof e=="string")return u(this,h).get(e);const t=u(this,y).call(this,e);return u(this,h).get(t)}relativeFrequencyOf(e){let t;if(typeof e=="string")t=u(this,h).get(e);else{const i=u(this,y).call(this,e);t=u(this,h).get(i)}if(t===void 0)return;const r=this.minMaxAvg();return t/r.total}entries(){return Array.from(u(this,h).entries())}minMaxAvg(){return V.minMaxAvg(this.entries())}entriesSorted(e="value"){return X(e)(this.entries())}add(...e){if(e===void 0)throw new Error("value parameter is undefined");e.map(u(this,y)).forEach(r=>{const i=u(this,h).get(r)??0;u(this,h).set(r,i+1)}),this.fireEvent("change",void 0)}};h=new WeakMap;y=new WeakMap;var de=e=>new U(e),ve=(e=100,t)=>{let r=$({capacity:e,discardPolicy:"older"});const i=()=>{r=$({capacity:e,discardPolicy:"older"})},n=()=>t===void 0?b.average(...r.data):b.averageWeighted(r.data,t);return{add:a=>(r.enqueue(a),n()),compute:n,clear:i}},me={};m(me,{count:()=>pe,forEach:()=>we,numericRange:()=>J,numericRangeRaw:()=>ye,pingPong:()=>Y,pingPongPercent:()=>ge,rangePercent:()=>xe});var ge=function(e=.1,t,r,i,n=1e3){return t===void 0&&(t=0),r===void 0&&(r=1),i===void 0&&(i=t),v(e,"bipolar","interval"),v(r,"bipolar","end"),v(i,"bipolar","offset"),v(t,"bipolar","start"),Y(e,t,r,i,n)},Y=function*(e,t,r,i,n=1){if(Number.isNaN(e))throw new Error("interval parameter is NaN");if(Number.isNaN(t))throw new Error("lower parameter is NaN");if(Number.isNaN(r))throw new Error("upper parameter is NaN");if(Number.isNaN(i))throw new Error("upper parameter is NaN");if(t>=r)throw new Error("lower must be less than upper");if(e===0)throw new Error("Interval cannot be zero");const s=r-t;if(Math.abs(e)>=s)throw new Error(`Interval should be between -${s} and ${s}`);let a=e>0;if(r=Math.floor(r*n),t=Math.floor(t*n),e=Math.floor(Math.abs(e*n)),i===void 0?i=t:i=Math.floor(i*n),i>r||i<t)throw new Error(`Start (${i/n}) must be within lower (${t/n}) and upper (${r/n})`);let l=i;yield l/n;let d=!0;for(;;)l=l+(a?e:-e),a&&l>=r?(a=!1,l=r,l===r&&d&&(l=t,a=!0)):!a&&l<=t&&(a=!0,l=t,l===t&&d&&(l=r,a=!1)),yield l/n,d=!1},ye=function*(e,t=0,r,i=!1){if(e<=0)throw new Error("Interval is expected to be above zero");r===void 0&&(r=Number.MAX_SAFE_INTEGER);let n=t;do for(;n<r;)yield n,n+=e;while(i)},we=(e,t)=>{for(const r of e){const i=t(r);if(typeof i=="boolean"&&!i)break}},J=function*(e,t=0,r,i=!1,n){v(e,"nonZero");const s=e<0;if(r!==void 0){if(s&&t<r)throw new Error(`Interval of ${e} will never go from ${t} to ${r}`);if(!s&&t>r)throw new Error(`Interval of ${e} will never go from ${t} to ${r}`)}n=n??1e3,r===void 0?r=Number.MAX_SAFE_INTEGER:r*=n,e=e*n;do{let a=t*n;for(;!s&&a<=r||s&&a>=r;)yield a/n,a+=e}while(i)},pe=function*(e,t=0){if(S(e,"","amount"),S(t,"","offset"),e===0)return;let r=0;do e<0?yield-r+t:yield r+t;while(r++<Math.abs(e)-1)},xe=function(e=.01,t=!1,r=0,i=1){return v(e,"percentage","interval"),v(r,"percentage","start"),v(i,"percentage","end"),J(e,r,i,t)},Ee={};m(Ee,{Analysers:()=>Z,Visualiser:()=>j});var Z={};m(Z,{basic:()=>be,default:()=>C,freq:()=>qe,peakLevel:()=>Me});var j={};m(j,{default:()=>Q});var W=class{constructor(e=void 0){o(this,"samples",0),o(this,"total",0),o(this,"min",0),o(this,"max",0),o(this,"id"),this.id=e}get avg(){return this.total/this.samples}resetAvg(e=null){e!==null&&(this.id=e),this.total=0,this.samples=0}reset(e=null){this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER,this.resetAvg(e)}seen(e){if(Number.isNaN(e))throw Error("Cannot add NaN");this.samples++,this.total+=e,this.min=Math.min(e,this.min),this.max=Math.max(e,this.max)}getMinMaxAvg(){return{min:this.min,max:this.max,avg:this.avg}}},Q=class{constructor(e,t){o(this,"freqMaxRange",200),o(this,"audio"),o(this,"parent"),o(this,"lastPointer",{x:0,y:0}),o(this,"pointerDown",!1),o(this,"pointerClicking",!1),o(this,"pointerClickDelayMs",100),o(this,"pointerDelaying",!1),o(this,"waveTracker"),o(this,"freqTracker"),o(this,"el"),this.audio=t,this.parent=e,this.waveTracker=new W("wave"),this.freqTracker=new W("freq"),e.innerHTML=`
    <section>
      <button id="rendererComponentToggle">\u{1F53C}</button>
      <div>
        <h1>Visualiser</h1>
        <div style="display:flex; flex-wrap: wrap">
          <div class="visPanel">
            <h2>Frequency distribution</h2>
            <br />
            <canvas id="rendererComponentFreqData" height="200" width="400"></canvas>
          </div>
          <div class="visPanel">
            <h2>Waveform</h2>
            <button id="rendererComponentWaveReset">Reset</button>
            <div>
              Press and hold on wave to measure
            </div>
            <br />
            <canvas id="rendererComponentWaveData" height="200" width="400"></canvas>
          </div>
        </div>
      </div>
    </section>
    `,this.el=e.children[0],document.getElementById("rendererComponentToggle")?.addEventListener("click",()=>{this.setExpanded(!this.isExpanded())}),this.el.addEventListener("pointermove",r=>this.onPointer(r)),this.el.addEventListener("pointerup",()=>{this.pointerDelaying=!1,this.pointerDown=!1}),this.el.addEventListener("pointerdown",()=>{this.pointerDelaying=!0,setTimeout(()=>{this.pointerDelaying&&(this.pointerDelaying=!1,this.pointerDown=!0)},this.pointerClickDelayMs)}),this.el.addEventListener("pointerleave",()=>{this.pointerDelaying=!1,this.pointerDown=!1}),document.getElementById("rendererComponentWaveReset")?.addEventListener("click",()=>{this.clear()})}renderFreq(e){if(!this.isExpanded()||!e)return;const t=document.getElementById("rendererComponentFreqData");if(t===null)throw new Error("Cannot find canvas element");const r=t.getContext("2d");if(r===null)throw new Error("Cannot create drawing context");const i=e.length,n=t.clientWidth,s=t.clientHeight;r.clearRect(0,0,n,s);const a=this.getPointerRelativeTo(t),l=n/i,d=b.minMaxAvg(e);for(let c=0;c<i;c++){if(!Number.isFinite(e[c]))continue;const x=(e[c]-d.min)/this.freqMaxRange,f=Math.abs(s*x),q=s-f,M=c/i*360,F=c*l;if(r.fillStyle="hsl("+M+", 100%, 50%)",a.y>0&&a.y<=s&&a.x>=F&&a.x<=F+l){this.freqTracker.id!==c.toString()&&this.freqTracker.reset(c.toString()),this.freqTracker.seen(e[c]);const T=this.freqTracker.getMinMaxAvg();r.fillStyle="black",this.audio&&r.fillText(`Frequency (${c}) at pointer: ${this.audio.getFrequencyAtIndex(c).toLocaleString("en")} - ${this.audio.getFrequencyAtIndex(c+1).toLocaleString("en")}`,2,10),r.fillText(`Raw value: ${e[c].toFixed(2)}`,2,20),r.fillText(`Min: ${T.min.toFixed(2)}`,2,40),r.fillText(`Max: ${T.max.toFixed(2)}`,60,40),r.fillText(`Avg: ${T.avg.toFixed(2)}`,120,40)}r.fillRect(F,q,l,f)}}isExpanded(){const e=this.el.querySelector("div");if(e===null)throw new Error("contents div not found");return e.style.display===""}setExpanded(e){const t=this.el.querySelector("div"),r=this.el.querySelector("button");if(r===null)throw new Error("Button element not found");if(t===null)throw new Error("Contents element not found");e?(t.style.display="",r.innerText="\u{1F53C}"):(t.style.display="none",r.innerText="\u{1F53D}")}clear(){this.clearCanvas(document.getElementById("rendererComponentFreqData")),this.clearCanvas(document.getElementById("rendererComponentWaveData"))}clearCanvas(e){if(e===null)throw new Error("Canvas is null");const t=e.getContext("2d");if(t===null)throw new Error("Cannot create drawing context");t.fillStyle="white",t.fillRect(0,0,e.clientWidth,e.clientHeight)}renderWave(e,t=!0){if(!this.isExpanded()||!e)return;const r=document.getElementById("rendererComponentWaveData");if(r===null)throw new Error("Cannot find wave canvas");const i=r.getContext("2d");if(i===null)throw new Error("Cannot create drawing context for wave");const n=r.clientWidth,s=r.clientHeight,a=this.getPointerRelativeTo(r),l=20,d=60,c=e.length;i.fillStyle="white",i.fillRect(0,0,d,l);const g=n/c;i.fillStyle="rgba(255, 255, 255, 0.03)",i.fillRect(0,20,n,s),i.fillStyle="red",t?i.fillRect(0,s/2,n,1):i.fillRect(0,s-1,n,1),i.lineWidth=1,i.strokeStyle="black",i.beginPath();let x=0;for(let f=0;f<c;f++){const q=e[f]*s,M=t?s/2-q:s-q;f===0?i.moveTo(x,M):i.lineTo(x,M),x+=g,this.pointerDown&&this.waveTracker.seen(e[f])}if(i.lineTo(n,t?s/2:s),i.stroke(),this.pointerDown){const f=this.waveTracker.getMinMaxAvg();i.fillStyle="rgba(255,255,0,1)",i.fillRect(d,0,150,20),i.fillStyle="black",i.fillText("Min: "+f.min.toFixed(2),60,10),i.fillText("Max: "+f.max.toFixed(2),110,10),i.fillText("Avg: "+f.avg.toFixed(2),160,10)}else this.waveTracker.reset();a.y>0&&a.y<=s&&a.x>=0&&a.x<=n&&(i.fillStyle="black",i.fillText("Level: "+(1-a.y/s).toFixed(2),2,10))}getPointerRelativeTo(e){const t=e.getBoundingClientRect();return{x:this.lastPointer.x-t.left-window.scrollX,y:this.lastPointer.y-t.top-window.scrollY}}onPointer(e){this.lastPointer={x:e.pageX,y:e.pageY},e.preventDefault()}},be=(e,t={})=>new C((r,i)=>{const n=new Float32Array(r.frequencyBinCount),s=new Float32Array(r.fftSize);r.getFloatFrequencyData(n),r.getFloatTimeDomainData(s),e(n,s,i)},t),qe=(e,t={})=>new C((r,i)=>{const n=new Float32Array(r.frequencyBinCount);r.getFloatFrequencyData(n),e(n,i)},t),Me=(e,t={})=>new C((r,i)=>{const n=new Float32Array(r.fftSize);r.getFloatTimeDomainData(n),e(b.maxFast(n),i)},t),E,w,C=class{constructor(e,t={}){if(o(this,"showVis"),o(this,"fftSize"),o(this,"smoothingTimeConstant"),A(this,E,!1),o(this,"debug"),A(this,w,!1),o(this,"visualiser"),o(this,"audioCtx"),o(this,"analyserNode"),o(this,"analyse"),this.showVis=t.showVis??!1,this.fftSize=t.fftSize??1024,this.debug=t.debug??!1,this.smoothingTimeConstant=t.smoothingTimeConstant??.8,S(this.fftSize,"positive","opts.fftSize"),v(this.smoothingTimeConstant,"percentage","opts.smoothingTimeConstant"),!te(this.fftSize))throw new Error(`fftSize must be a power of two from 32 to 32768 (${this.fftSize})`);if(this.fftSize<32)throw new Error("fftSize must be at least 32");if(this.fftSize>32768)throw new Error("fftSize must be no greater than 32768");this.analyse=e,this.paused=!1,this.init();const r=document.getElementById("audio-visualiser");if(r){const i=new Q(r,this);i.setExpanded(this.showVis),this.visualiser=i}}init(){if(u(this,w)){this.debug&&console.debug("Init already in progress");return}p(this,w,!0),navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{this.onMicSuccess(e)}).catch(e=>{p(this,w,!1),console.error(e)})}get paused(){return u(this,E)}set paused(e){e!==u(this,E)&&(p(this,E,e),e?this.debug&&console.log("Paused"):(this.debug&&console.log("Unpaused"),window.requestAnimationFrame(this.analyseLoop.bind(this))))}setup(e,t){const r=e.createAnalyser();return r.fftSize=this.fftSize,r.smoothingTimeConstant=this.smoothingTimeConstant,e.createMediaStreamSource(t).connect(r),r}onMicSuccess(e){try{const t=new AudioContext;t.addEventListener("statechange",()=>{this.debug&&console.log(`Audio context state: ${t.state}`)}),this.audioCtx=t,this.analyserNode=this.setup(t,e),window.requestAnimationFrame(this.analyseLoop.bind(this))}catch(t){p(this,w,!1),console.error(t)}}analyseLoop(){if(this.paused){this.debug&&console.log("Paused");return}const e=this.analyserNode;if(e===void 0){console.warn("Analyser undefined");return}try{this.analyse(e,this)}catch(t){console.error(t)}window.requestAnimationFrame(this.analyseLoop.bind(this))}getFrequencyRangeMax(e,t,r){const i=this.sliceByFrequency(e,t,r);return b.max(...i)}sliceByFrequency(e,t,r){const i=this.getIndexForFrequency(e),n=this.getIndexForFrequency(t);return r.slice(i,n)}getFrequencyAtIndex(e){const t=this.analyserNode,r=this.audioCtx;if(t===void 0)throw new Error("Analyser not available");if(r===void 0)throw new Error("Audio context not available");if(S(e,"positive","index"),e>t.frequencyBinCount)throw new Error(`Index ${e} exceeds frequency bin count ${t.frequencyBinCount}`);return e*r.sampleRate/(t.frequencyBinCount*2)}getIndexForFrequency(e){const t=this.analyserNode;if(t===void 0)throw new Error("Analyser not available");const r=t.context.sampleRate/2,i=Math.round(e/r*t.frequencyBinCount);return i<0?0:i>=t.frequencyBinCount?t.frequencyBinCount-1:i}};E=new WeakMap;w=new WeakMap;export{me as G,V as K,K as N,de as f,X as g};
